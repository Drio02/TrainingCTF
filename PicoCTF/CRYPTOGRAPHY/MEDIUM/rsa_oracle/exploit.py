from subprocess import run, PIPE

# Obtener el ciphertext del archivo password.enc
with open("password.enc", "r") as f:
	c = int(f.read())

print("Fase 1: Obtener la contrasena:\n")

print(f"c = {c}\n")

#Obtener el mensaje del usuario
m1 = input("Enter de input(m1): ")
m1_bytes = bytes(m1, "utf-8")
m1_int = ord(m1_bytes)

print(f"EL oraculo tiene que encriptar el siguiente mensaje (m1): {m1}\n" )
c1 = int(input("Enter ciphertext del oraculo (c1 = E(m1)): "))
print("\n")

# Explotar la propiedad homomorfica de RSA

c2 = c * c1
print(f"EL oraculo tiene que desencriptar el siguiente mensaje (c2 = c * c1): {c2}\n")


m2 = int(input("Meter el mensaje encriptado en formato HEX (m2 = D(c2)): "), 16)
print("\n")


# Seguir explotando
m_int = m2 // m1_int
m = m_int.to_bytes(len(str(m_int)), "big").decode("utf-8").lstrip("\x00") # Buscar que hace esta instruccion
print(f"Password (m = m2 / m1): {m}\n")

print('-'*50)

print("FAse 2: Desencriptar el mensaje")

#res = run(["openssl", "enc", "-aes-256-cbc", "-d", "-in", "secrete.enc", "-pass", f"pass:{m}"], stdout=PIPE, stderr=PIPE, text=True)

res = run(["openssl", "enc", "-aes-256-cbc", "-d", "-in", "secret.enc", "-pass", f"pass:{m}"], stdout=PIPE, stderr=PIPE, text=True)
print(res.stdout)
